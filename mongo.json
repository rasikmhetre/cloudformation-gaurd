{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Outputs": {
    "MongoEcsClusterName": {
      "Export": {
        "Name": {
          "Fn::Sub": "${AWS::StackName}-Service-MongoEcsClusterName"
        }
      },
      "Value": {
        "Ref": "MongoEcsCluster"
      }
    }
  },
  "Resources": {
    "MongoEbsDlmLifecyclePolicy": {
      "Properties": {
        "Description": {
          "Fn::Join": [
            "-",
            [
              {
                "Ref": "AWS::StackName"
              },
              "MongoVolumeXvdp",
              "LifecyclePolicy"
            ]
          ]
        },
        "ExecutionRoleArn": {
          "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:role/service-role/AWSDataLifecycleManagerServiceRole"
        },
        "PolicyDetails": {
          "ResourceTypes": [
            "VOLUME"
          ],
          "Schedules": [
            {
              "CopyTags": true,
              "CreateRule": {
                "Interval": 24,
                "IntervalUnit": "HOURS",
                "Times": [
                  "00:00"
                ]
              },
              "Name": {
                "Fn::Join": [
                  "-",
                  [
                    {
                      "Ref": "AWS::StackName"
                    },
                    "SnapshotSchedule"
                  ]
                ]
              },
              "RetainRule": {
                "Count": 2
              }
            }
          ],
          "TargetTags": [
            {
              "Key": "DlmIdentifier",
              "Value": {
                "Fn::Join": [
                  "-",
                  [
                    {
                      "Ref": "AWS::StackName"
                    },
                    "MongoVolumeXvdp"
                  ]
                ]
              }
            }
          ]
        },
        "State": "ENABLED"
      },
      "Type": "AWS::DLM::LifecyclePolicy"
    },
    "MongoEc2InstanceIamInstanceProfile": {
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "MongoEc2InstanceIamRole"
          }
        ]
      },
      "Type": "AWS::IAM::InstanceProfile"
    },
    "MongoEc2InstanceIamPolicy": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ecs:DeregisterContainerInstance",
                "ecs:DiscoverPollEndpoint",
                "ecs:Poll",
                "ecs:RegisterContainerInstance",
                "ecs:StartTelemetrySession",
                "ecs:Submit*"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "AllowInteractionWithEcsCluster"
            },
            {
              "Action": [
                "ecr:GetAuthorizationToken",
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:GetRepositoryPolicy",
                "ecr:DescribeRepositories",
                "ecr:ListImages",
                "ecr:BatchGetImage"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "AbilityToCheckoutFromEcr"
            },
            {
              "Action": [
                "cloudwatch:GetMetricStatistics"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "AbilityToPullMetricsFromCloudwatch"
            },
            {
              "Action": [
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "WriteLogsToCloudWatchLogs"
            },
            {
              "Action": [
                "ec2messages:*",
                "ssm:ListAssociations",
                "ssm:ListInstanceAssociations"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "AllowSsmAgentToFunction"
            },
            {
              "Action": [
                "ssmmessages:*",
                "ssm:UpdateInstanceInformation"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "AllowTwoWayWebsocketChannelComminicationBetweenTheClientBrowserOrCliAndRemoteManagedInstance"
            },
            {
              "Action": [
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::ImportValue": "eu1-SharedResources-SsmLogsLogGroupArn"
              },
              "Sid": "AllowSsmAccessToCloudWatchLogGroup"
            },
            {
              "Action": [
                "s3:GetObject"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::ImportValue": "eu1-SharedResources-RuncommandAutomationScriptsS3BucketArn"
                      },
                      "latest"
                    ]
                  ]
                },
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::ImportValue": "eu1-SharedResources-RuncommandAutomationScriptsS3BucketArn"
                      },
                      "latest",
                      "*"
                    ]
                  ]
                }
              ],
              "Sid": "AllowMongoAccessToReadAtomationScriptsFromS3"
            },
            {
              "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:CreateMultipartUpload",
                "s3:ListMultipartUploadParts",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::ImportValue": "eu1-SharedResources-SsmS3BucketArn"
                },
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::ImportValue": "eu1-SharedResources-SsmS3BucketArn"
                      },
                      "*"
                    ]
                  ]
                },
                {
                  "Fn::ImportValue": "eu1-SharedResources-MongoLogsS3BucketArn"
                },
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::ImportValue": "eu1-SharedResources-MongoLogsS3BucketArn"
                      },
                      "*"
                    ]
                  ]
                }
              ],
              "Sid": "AllowSsmAgentToPutLogsToS3"
            },
            {
              "Action": [
                "kms:GenerateDataKey",
                "kms:Decrypt"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "AllowSSMAgentToGetKMSGeneratedDataKeyWhenAccessingS3Bucket"
            },
            {
              "Action": [
                "s3:GetEncryptionConfiguration"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "AllowSsmToGetS3EncryptionConfiguration"
            },
            {
              "Action": [
                "ec2:DescribeTags"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "AllowBootstrapViaCloudInitToBeAbleToDescribeTags"
            },
            {
              "Action": [
                "ec2:DescribeTags",
                "ec2:DescribeInstances",
                "ec2:DescribeInstanceStatus"
              ],
              "Effect": "Allow",
              "Resource": "*",
              "Sid": "AllowDescribeInstances"
            },
            {
              "Action": [
                "s3:GetObject",
                "s3:GetObjectAcl",
                "s3:GetBucketLocation",
                "s3:ListObjects",
                "s3:ListObjectsV2",
                "s3:ListBucket"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::ImportValue": "eu1-SharedResources-FluentBitConfigS3BucketArn"
                },
                {
                  "Fn::Join": [
                    "/",
                    [
                      {
                        "Fn::ImportValue": "eu1-SharedResources-FluentBitConfigS3BucketArn"
                      },
                      "*"
                    ]
                  ]
                }
              ],
              "Sid": "AllowFluentbitConfigurationS3Bucket"
            }
          ]
        },
        "PolicyName": {
          "Fn::Join": [
            "-",
            [
              {
                "Ref": "AWS::StackName"
              },
              "LogCollectorEc2InstanceIamPolicy"
            ]
          ]
        },
        "Roles": [
          {
            "Ref": "MongoEc2InstanceIamRole"
          }
        ]
      },
      "Type": "AWS::IAM::Policy"
    },
    "MongoEc2InstanceIamRole": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Sid": "RoleMappedToContainerInstancesViaEc2InstanceIamInstanceProfile"
            }
          ]
        },
        "Path": "/"
      },
      "Type": "AWS::IAM::Role"
    },
    "MongoEcsCluster": {
      "Properties": {},
      "Type": "AWS::ECS::Cluster"
    },
    "MongoReplicaSetEncryptedVolumeXvdp010169": {
      "DeletionPolicy": "Snapshot",
      "UpdateReplacePolicy": "Snapshot",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "a"
            ]
          ]
        },
        "Encrypted": true,
        "Iops": 16000,
        "KmsKeyId": {
          "Fn::GetAtt": [
            "MongoVolumeXvdpKmsKey",
            "Arn"
          ]
        },
        "Size": 1536,
        "Tags": [
          {
            "Key": "DlmIdentifier",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "MongoVolumeXvdp"
                ]
              ]
            }
          }
        ],
        "Throughput": 512,
        "VolumeType": "gp3"
      },
      "Type": "AWS::EC2::Volume"
    },
    "MongoReplicaSetEncryptedVolumeXvdp010170": {
      "UpdateReplacePolicy": "Snapshot",
      "DeletionPolicy": "Snapshot",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "a"
            ]
          ]
        },
        "Encrypted": true,
        "Iops": 16000,
        "KmsKeyId": {
          "Fn::GetAtt": [
            "MongoVolumeXvdpKmsKey",
            "Arn"
          ]
        },
        "Size": 1344,
        "SnapshotId": "snap-076e1605d80e2152f",
        "Tags": [
          {
            "Key": "DlmIdentifier",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "MongoVolumeXvdp"
                ]
              ]
            }
          }
        ],
        "Throughput": 512,
        "VolumeType": "gp3"
      },
      "Type": "AWS::EC2::Volume"
    },
    "MongoReplicaSetEncryptedVolumeXvdp010185": {
      "UpdateReplacePolicy": "Snapshot",
      "DeletionPolicy": "Snapshot",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "b"
            ]
          ]
        },
        "Encrypted": true,
        "Iops": 16000,
        "KmsKeyId": {
          "Fn::GetAtt": [
            "MongoVolumeXvdpKmsKey",
            "Arn"
          ]
        },
        "Size": 1536,
        "Tags": [
          {
            "Key": "DlmIdentifier",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "MongoVolumeXvdp"
                ]
              ]
            }
          }
        ],
        "Throughput": 512,
        "VolumeType": "gp3"
      },
      "Type": "AWS::EC2::Volume"
    },
    "MongoReplicaSetEncryptedVolumeXvdp010186": {
      "UpdateReplacePolicy": "Snapshot",
      "DeletionPolicy": "Snapshot",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "b"
            ]
          ]
        },
        "Encrypted": true,
        "Iops": 16000,
        "KmsKeyId": {
          "Fn::GetAtt": [
            "MongoVolumeXvdpKmsKey",
            "Arn"
          ]
        },
        "Size": 1344,
        "SnapshotId": "snap-076e1605d80e2152f",
        "Tags": [
          {
            "Key": "DlmIdentifier",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "MongoVolumeXvdp"
                ]
              ]
            }
          }
        ],
        "Throughput": 512,
        "VolumeType": "gp3"
      },
      "Type": "AWS::EC2::Volume"
    },
    "MongoReplicaSetEncryptedVolumeXvdp010201": {
      "UpdateReplacePolicy": "Snapshot",
      "DeletionPolicy": "Snapshot",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "c"
            ]
          ]
        },
        "Encrypted": true,
        "Iops": 16000,
        "KmsKeyId": {
          "Fn::GetAtt": [
            "MongoVolumeXvdpKmsKey",
            "Arn"
          ]
        },
        "Size": 1536,
        "Tags": [
          {
            "Key": "DlmIdentifier",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "MongoVolumeXvdp"
                ]
              ]
            }
          }
        ],
        "Throughput": 512,
        "VolumeType": "gp3"
      },
      "Type": "AWS::EC2::Volume"
    },
    "MongoReplicaSetEncryptedVolumeXvdp010202": {
      "UpdateReplacePolicy": "Snapshot",
      "DeletionPolicy": "Snapshot",
      "Properties": {
        "AvailabilityZone": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "c"
            ]
          ]
        },
        "Encrypted": true,
        "Iops": 16000,
        "KmsKeyId": {
          "Fn::GetAtt": [
            "MongoVolumeXvdpKmsKey",
            "Arn"
          ]
        },
        "Size": 1536,
        "Tags": [
          {
            "Key": "DlmIdentifier",
            "Value": {
              "Fn::Join": [
                "-",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "MongoVolumeXvdp"
                ]
              ]
            }
          }
        ],
        "Throughput": 512,
        "VolumeType": "gp3"
      },
      "Type": "AWS::EC2::Volume"
    },
    "MongoReplicaSetInstance010170": {
      "Properties": {
        "DisableApiTermination": false,
        "IamInstanceProfile": {
          "Ref": "MongoEc2InstanceIamInstanceProfile"
        },
        "ImageId": "ami-0d7a65c5a518a12c3",
        "InstanceInitiatedShutdownBehavior": "stop",
        "InstanceType": "r5.8xlarge",
        "Monitoring": true,
        "PrivateIpAddress": {
          "Fn::Join": [
            ".",
            [
              {
                "Fn::ImportValue": "eu1-VpcNetworkPrefix"
              },
              "10.170"
            ]
          ]
        },
        "SecurityGroupIds": [
          {
            "Fn::ImportValue": "eu1-SecurityGroup-MongoWhatsappEc2InstanceEC2SecurityGroupId"
          }
        ],
        "SubnetId": {
          "Ref": "MongoReplicaSetSubnetA"
        },
        "Tags": [
          {
            "Key": "customer",
            "Value": "clevertap"
          },
          {
            "Key": "role",
            "Value": "mongo"
          },
          {
            "Key": "ecs_cluster",
            "Value": {
              "Ref": "MongoEcsCluster"
            }
          }
        ],
        "Volumes": [
          {
            "Device": "/dev/sdp",
            "VolumeId": {
              "Ref": "MongoReplicaSetEncryptedVolumeXvdp010170"
            }
          }
        ]
      },
      "Type": "AWS::EC2::Instance"
    },
    "MongoReplicaSetInstance010186": {
      "Properties": {
        "DisableApiTermination": false,
        "IamInstanceProfile": {
          "Ref": "MongoEc2InstanceIamInstanceProfile"
        },
        "ImageId": "ami-0d7a65c5a518a12c3",
        "InstanceInitiatedShutdownBehavior": "stop",
        "InstanceType": "r5.8xlarge",
        "Monitoring": true,
        "PrivateIpAddress": {
          "Fn::Join": [
            ".",
            [
              {
                "Fn::ImportValue": "eu1-VpcNetworkPrefix"
              },
              "10.186"
            ]
          ]
        },
        "SecurityGroupIds": [
          {
            "Fn::ImportValue": "eu1-SecurityGroup-MongoWhatsappEc2InstanceEC2SecurityGroupId"
          }
        ],
        "SubnetId": {
          "Ref": "MongoReplicaSetSubnetB"
        },
        "Tags": [
          {
            "Key": "customer",
            "Value": "clevertap"
          },
          {
            "Key": "role",
            "Value": "mongo"
          },
          {
            "Key": "ecs_cluster",
            "Value": {
              "Ref": "MongoEcsCluster"
            }
          }
        ],
        "Volumes": [
          {
            "Device": "/dev/sdp",
            "VolumeId": {
              "Ref": "MongoReplicaSetEncryptedVolumeXvdp010186"
            }
          }
        ]
      },
      "Type": "AWS::EC2::Instance"
    },
    "MongoReplicaSetInstance010202": {
      "Properties": {
        "DisableApiTermination": false,
        "IamInstanceProfile": {
          "Ref": "MongoEc2InstanceIamInstanceProfile"
        },
        "ImageId": "ami-0d7a65c5a518a12c3",
        "InstanceInitiatedShutdownBehavior": "stop",
        "InstanceType": "r5.8xlarge",
        "Monitoring": true,
        "PrivateIpAddress": {
          "Fn::Join": [
            ".",
            [
              {
                "Fn::ImportValue": "eu1-VpcNetworkPrefix"
              },
              "10.202"
            ]
          ]
        },
        "SecurityGroupIds": [
          {
            "Fn::ImportValue": "eu1-SecurityGroup-MongoWhatsappEc2InstanceEC2SecurityGroupId"
          }
        ],
        "SubnetId": {
          "Ref": "MongoReplicaSetSubnetC"
        },
        "Tags": [
          {
            "Key": "customer",
            "Value": "clevertap"
          },
          {
            "Key": "role",
            "Value": "mongo"
          },
          {
            "Key": "ecs_cluster",
            "Value": {
              "Ref": "MongoEcsCluster"
            }
          }
        ],
        "Volumes": [
          {
            "Device": "/dev/sdp",
            "VolumeId": {
              "Ref": "MongoReplicaSetEncryptedVolumeXvdp010202"
            }
          }
        ]
      },
      "Type": "AWS::EC2::Instance"
    },
    "MongoReplicaSetSubnetA": {
      "Properties": {
        "AvailabilityZone": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "a"
            ]
          ]
        },
        "CidrBlock": {
          "Fn::Join": [
            ".",
            [
              {
                "Fn::ImportValue": "eu1-VpcNetworkPrefix"
              },
              "10.164/28"
            ]
          ]
        },
        "VpcId": {
          "Fn::ImportValue": "eu1-VpcId"
        }
      },
      "Type": "AWS::EC2::Subnet"
    },
    "MongoReplicaSetSubnetARouteTableAssociation": {
      "Properties": {
        "RouteTableId": {
          "Fn::ImportValue": "eu1-RouteTableNatId"
        },
        "SubnetId": {
          "Ref": "MongoReplicaSetSubnetA"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    },
    "MongoReplicaSetSubnetB": {
      "Properties": {
        "AvailabilityZone": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "b"
            ]
          ]
        },
        "CidrBlock": {
          "Fn::Join": [
            ".",
            [
              {
                "Fn::ImportValue": "eu1-VpcNetworkPrefix"
              },
              "10.180/28"
            ]
          ]
        },
        "VpcId": {
          "Fn::ImportValue": "eu1-VpcId"
        }
      },
      "Type": "AWS::EC2::Subnet"
    },
    "MongoReplicaSetSubnetBRouteTableAssociation": {
      "Properties": {
        "RouteTableId": {
          "Fn::ImportValue": "eu1-Nat1bEc2RouteTableId"
        },
        "SubnetId": {
          "Ref": "MongoReplicaSetSubnetB"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    },
    "MongoReplicaSetSubnetC": {
      "Properties": {
        "AvailabilityZone": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "AWS::Region"
              },
              "c"
            ]
          ]
        },
        "CidrBlock": {
          "Fn::Join": [
            ".",
            [
              {
                "Fn::ImportValue": "eu1-VpcNetworkPrefix"
              },
              "10.196/28"
            ]
          ]
        },
        "VpcId": {
          "Fn::ImportValue": "eu1-VpcId"
        }
      },
      "Type": "AWS::EC2::Subnet"
    },
    "MongoReplicaSetSubnetCRouteTableAssociation": {
      "Properties": {
        "RouteTableId": {
          "Fn::ImportValue": "eu1-RouteTableNatId"
        },
        "SubnetId": {
          "Ref": "MongoReplicaSetSubnetC"
        }
      },
      "Type": "AWS::EC2::SubnetRouteTableAssociation"
    },
    "MongoVolumeXvdpKmsKey": {
      "Properties": {
        "Description": "KMS key used for Encrypted volume",
        "EnableKeyRotation": true,
        "Enabled": true,
        "KeyPolicy": {
          "Id": "key-default-1",
          "Statement": [
            {
              "Action": "kms:*",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Join": [
                    ":",
                    [
                      "arn:aws:iam:",
                      {
                        "Ref": "AWS::AccountId"
                      },
                      "root"
                    ]
                  ]
                }
              },
              "Resource": "*",
              "Sid": "EnableIamPoliciesToGiveIamUsersAndRolesInTheAccountAccessToThisCmk"
            }
          ],
          "Version": "2012-10-17"
        },
        "Tags": [
          {
            "Key": "ct-aws:cloudformation:stack-name",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "Identifier",
            "Value": {
              "Fn::Sub": "${AWS::StackName}-MongoVolumeKmsKey"
            }
          }
        ]
      },
      "Type": "AWS::KMS::Key"
    }
  }
}
